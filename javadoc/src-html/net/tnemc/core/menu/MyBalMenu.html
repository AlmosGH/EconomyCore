<!DOCTYPE HTML>
<html lang>
<head>
<!-- Generated by javadoc (21) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: net.tnemc.core.menu, class: MyBalMenu">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package net.tnemc.core.menu;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">/*</span>
<span class="source-line-no">004</span><span id="line-4"> * The New Economy</span>
<span class="source-line-no">005</span><span id="line-5"> * Copyright (C) 2022 - 2024 Daniel "creatorfromhell" Vidmar</span>
<span class="source-line-no">006</span><span id="line-6"> *</span>
<span class="source-line-no">007</span><span id="line-7"> * This program is free software: you can redistribute it and/or modify</span>
<span class="source-line-no">008</span><span id="line-8"> * it under the terms of the GNU Affero General Public License as published by</span>
<span class="source-line-no">009</span><span id="line-9"> * the Free Software Foundation, either version 3 of the License, or</span>
<span class="source-line-no">010</span><span id="line-10"> * (at your option) any later version.</span>
<span class="source-line-no">011</span><span id="line-11"> *</span>
<span class="source-line-no">012</span><span id="line-12"> * This program is distributed in the hope that it will be useful,</span>
<span class="source-line-no">013</span><span id="line-13"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="source-line-no">014</span><span id="line-14"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="source-line-no">015</span><span id="line-15"> * GNU Affero General Public License for more details.</span>
<span class="source-line-no">016</span><span id="line-16"> *</span>
<span class="source-line-no">017</span><span id="line-17"> * You should have received a copy of the GNU Affero General Public License</span>
<span class="source-line-no">018</span><span id="line-18"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="source-line-no">019</span><span id="line-19"> */</span>
<span class="source-line-no">020</span><span id="line-20"></span>
<span class="source-line-no">021</span><span id="line-21">import net.kyori.adventure.text.Component;</span>
<span class="source-line-no">022</span><span id="line-22">import net.tnemc.core.EconomyManager;</span>
<span class="source-line-no">023</span><span id="line-23">import net.tnemc.core.TNECore;</span>
<span class="source-line-no">024</span><span id="line-24">import net.tnemc.core.account.Account;</span>
<span class="source-line-no">025</span><span id="line-25">import net.tnemc.core.account.PlayerAccount;</span>
<span class="source-line-no">026</span><span id="line-26">import net.tnemc.core.account.holdings.HoldingsEntry;</span>
<span class="source-line-no">027</span><span id="line-27">import net.tnemc.core.account.holdings.modify.HoldingsModifier;</span>
<span class="source-line-no">028</span><span id="line-28">import net.tnemc.core.actions.source.PlayerSource;</span>
<span class="source-line-no">029</span><span id="line-29">import net.tnemc.core.config.MainConfig;</span>
<span class="source-line-no">030</span><span id="line-30">import net.tnemc.core.currency.Currency;</span>
<span class="source-line-no">031</span><span id="line-31">import net.tnemc.core.currency.Note;</span>
<span class="source-line-no">032</span><span id="line-32">import net.tnemc.core.currency.format.CurrencyFormatter;</span>
<span class="source-line-no">033</span><span id="line-33">import net.tnemc.core.currency.type.MixedType;</span>
<span class="source-line-no">034</span><span id="line-34">import net.tnemc.core.currency.type.VirtualType;</span>
<span class="source-line-no">035</span><span id="line-35">import net.tnemc.core.menu.handlers.AmountSelectionHandler;</span>
<span class="source-line-no">036</span><span id="line-36">import net.tnemc.core.menu.icons.shared.PreviousPageIcon;</span>
<span class="source-line-no">037</span><span id="line-37">import net.tnemc.core.menu.page.mybal.MyBalAmountSelectionPage;</span>
<span class="source-line-no">038</span><span id="line-38">import net.tnemc.core.menu.page.shared.AccountSelectionPage;</span>
<span class="source-line-no">039</span><span id="line-39">import net.tnemc.core.menu.page.shared.CurrencySelectionPage;</span>
<span class="source-line-no">040</span><span id="line-40">import net.tnemc.core.transaction.Receipt;</span>
<span class="source-line-no">041</span><span id="line-41">import net.tnemc.core.transaction.Transaction;</span>
<span class="source-line-no">042</span><span id="line-42">import net.tnemc.core.transaction.TransactionResult;</span>
<span class="source-line-no">043</span><span id="line-43">import net.tnemc.core.utils.exceptions.InvalidTransactionException;</span>
<span class="source-line-no">044</span><span id="line-44">import net.tnemc.item.AbstractItemStack;</span>
<span class="source-line-no">045</span><span id="line-45">import net.tnemc.menu.core.Menu;</span>
<span class="source-line-no">046</span><span id="line-46">import net.tnemc.menu.core.Page;</span>
<span class="source-line-no">047</span><span id="line-47">import net.tnemc.menu.core.builder.IconBuilder;</span>
<span class="source-line-no">048</span><span id="line-48">import net.tnemc.menu.core.builder.PageBuilder;</span>
<span class="source-line-no">049</span><span id="line-49">import net.tnemc.menu.core.callbacks.page.PageOpenCallback;</span>
<span class="source-line-no">050</span><span id="line-50">import net.tnemc.menu.core.icon.Icon;</span>
<span class="source-line-no">051</span><span id="line-51">import net.tnemc.menu.core.icon.action.ActionType;</span>
<span class="source-line-no">052</span><span id="line-52">import net.tnemc.menu.core.icon.action.IconAction;</span>
<span class="source-line-no">053</span><span id="line-53">import net.tnemc.menu.core.icon.action.impl.DataAction;</span>
<span class="source-line-no">054</span><span id="line-54">import net.tnemc.menu.core.icon.action.impl.SwitchPageAction;</span>
<span class="source-line-no">055</span><span id="line-55">import net.tnemc.menu.core.viewer.MenuViewer;</span>
<span class="source-line-no">056</span><span id="line-56">import net.tnemc.plugincore.PluginCore;</span>
<span class="source-line-no">057</span><span id="line-57">import net.tnemc.plugincore.core.compatibility.PlayerProvider;</span>
<span class="source-line-no">058</span><span id="line-58">import net.tnemc.plugincore.core.io.message.MessageData;</span>
<span class="source-line-no">059</span><span id="line-59">import net.tnemc.plugincore.core.io.message.MessageHandler;</span>
<span class="source-line-no">060</span><span id="line-60"></span>
<span class="source-line-no">061</span><span id="line-61">import java.math.BigDecimal;</span>
<span class="source-line-no">062</span><span id="line-62">import java.math.RoundingMode;</span>
<span class="source-line-no">063</span><span id="line-63">import java.util.Collection;</span>
<span class="source-line-no">064</span><span id="line-64">import java.util.Collections;</span>
<span class="source-line-no">065</span><span id="line-65">import java.util.LinkedList;</span>
<span class="source-line-no">066</span><span id="line-66">import java.util.Optional;</span>
<span class="source-line-no">067</span><span id="line-67">import java.util.UUID;</span>
<span class="source-line-no">068</span><span id="line-68"></span>
<span class="source-line-no">069</span><span id="line-69">/**</span>
<span class="source-line-no">070</span><span id="line-70"> * MyBalMenu</span>
<span class="source-line-no">071</span><span id="line-71"> *</span>
<span class="source-line-no">072</span><span id="line-72"> * @author creatorfromhell</span>
<span class="source-line-no">073</span><span id="line-73"> * @since 0.1.3.0</span>
<span class="source-line-no">074</span><span id="line-74"> */</span>
<span class="source-line-no">075</span><span id="line-75">public class MyBalMenu extends Menu {</span>
<span class="source-line-no">076</span><span id="line-76"></span>
<span class="source-line-no">077</span><span id="line-77">  public static final int BALANCE_ACTIONS_PAGE = 2;</span>
<span class="source-line-no">078</span><span id="line-78">  public static final int BALANCE_ACTION_CONVERT_CURRENCY_PAGE = 3;</span>
<span class="source-line-no">079</span><span id="line-79">  public static final int BALANCE_ACTION_CONVERT_AMOUNT_PAGE = 4;</span>
<span class="source-line-no">080</span><span id="line-80">  public static final int BALANCE_ACTION_DEPOSIT_AMOUNT_PAGE = 5;</span>
<span class="source-line-no">081</span><span id="line-81">  public static final int BALANCE_ACTION_WITHDRAW_AMOUNT_PAGE = 6;</span>
<span class="source-line-no">082</span><span id="line-82">  public static final int BALANCE_BREAKDOWN_PAGE = 7;</span>
<span class="source-line-no">083</span><span id="line-83">  public static final int BALANCE_PAY_PAGE = 8;</span>
<span class="source-line-no">084</span><span id="line-84">  public static final int BALANCE_PAY_AMOUNT_PAGE = 9;</span>
<span class="source-line-no">085</span><span id="line-85">  public static final int BALANCE_NOTE_AMOUNT_PAGE = 10;</span>
<span class="source-line-no">086</span><span id="line-86"></span>
<span class="source-line-no">087</span><span id="line-87">  public static final String ACTION_ACCOUNT_ID = "ACTION_ACCOUNT";</span>
<span class="source-line-no">088</span><span id="line-88">  public static final String ACTION_CURRENCY = "ACTION_CURRENCY";</span>
<span class="source-line-no">089</span><span id="line-89">  public static final String ACTION_CONVERT_CURRENCY = "ACTION_CURRENCY";</span>
<span class="source-line-no">090</span><span id="line-90">  public static final String ACTION_MAX_HOLDINGS = "ACTION_MAX_HOLDINGS";</span>
<span class="source-line-no">091</span><span id="line-91">  public static final String ACTION_HOLDINGS = "ACTION_HOLDINGS";</span>
<span class="source-line-no">092</span><span id="line-92"></span>
<span class="source-line-no">093</span><span id="line-93">  public MyBalMenu() {</span>
<span class="source-line-no">094</span><span id="line-94"></span>
<span class="source-line-no">095</span><span id="line-95">    this.name = "my_bal";</span>
<span class="source-line-no">096</span><span id="line-96">    this.title = "My Bal";</span>
<span class="source-line-no">097</span><span id="line-97">    this.rows = 6;</span>
<span class="source-line-no">098</span><span id="line-98"></span>
<span class="source-line-no">099</span><span id="line-99">    /*</span>
<span class="source-line-no">100</span><span id="line-100">     * Main Page</span>
<span class="source-line-no">101</span><span id="line-101">     */</span>
<span class="source-line-no">102</span><span id="line-102">    final Page main = new PageBuilder(1).build();</span>
<span class="source-line-no">103</span><span id="line-103">    main.setOpen(this::handleMainPage);</span>
<span class="source-line-no">104</span><span id="line-104">    addPage(main);</span>
<span class="source-line-no">105</span><span id="line-105"></span>
<span class="source-line-no">106</span><span id="line-106">    final Page balanceActionsPage = new PageBuilder(BALANCE_ACTIONS_PAGE).build();</span>
<span class="source-line-no">107</span><span id="line-107">    balanceActionsPage.setOpen(this::actionsPage);</span>
<span class="source-line-no">108</span><span id="line-108">    addPage(balanceActionsPage);</span>
<span class="source-line-no">109</span><span id="line-109"></span>
<span class="source-line-no">110</span><span id="line-110">    final Page balanceConvertCurrencyPage = new PageBuilder(BALANCE_ACTION_CONVERT_CURRENCY_PAGE).build();</span>
<span class="source-line-no">111</span><span id="line-111">    balanceConvertCurrencyPage.setOpen((open-&gt;new CurrencySelectionPage(ACTION_CONVERT_CURRENCY, this.name, this.name, BALANCE_ACTION_CONVERT_CURRENCY_PAGE, BALANCE_ACTION_CONVERT_AMOUNT_PAGE, "CONVERT_CURRENCY_SELECTION", this.rows).handle(open)));</span>
<span class="source-line-no">112</span><span id="line-112">    addPage(balanceConvertCurrencyPage);</span>
<span class="source-line-no">113</span><span id="line-113"></span>
<span class="source-line-no">114</span><span id="line-114">    final Page balanceConvertAmountPage = new PageBuilder(BALANCE_ACTION_CONVERT_AMOUNT_PAGE).build();</span>
<span class="source-line-no">115</span><span id="line-115">    balanceConvertAmountPage.setOpen((open-&gt;new MyBalAmountSelectionPage(ACTION_HOLDINGS, this.name, this.name, BALANCE_ACTION_CONVERT_AMOUNT_PAGE, -1, this::convert).handle(open)));</span>
<span class="source-line-no">116</span><span id="line-116">    addPage(balanceConvertAmountPage);</span>
<span class="source-line-no">117</span><span id="line-117"></span>
<span class="source-line-no">118</span><span id="line-118">    final Page balanceDepositAmountPage = new PageBuilder(BALANCE_ACTION_DEPOSIT_AMOUNT_PAGE).build();</span>
<span class="source-line-no">119</span><span id="line-119">    balanceDepositAmountPage.setOpen((open-&gt;new MyBalAmountSelectionPage(ACTION_HOLDINGS, this.name, this.name, BALANCE_ACTION_DEPOSIT_AMOUNT_PAGE, -1, this::deposit).handle(open)));</span>
<span class="source-line-no">120</span><span id="line-120">    addPage(balanceDepositAmountPage);</span>
<span class="source-line-no">121</span><span id="line-121"></span>
<span class="source-line-no">122</span><span id="line-122">    final Page balanceWithdrawAmountPage = new PageBuilder(BALANCE_ACTION_WITHDRAW_AMOUNT_PAGE).build();</span>
<span class="source-line-no">123</span><span id="line-123">    balanceWithdrawAmountPage.setOpen((open-&gt;new MyBalAmountSelectionPage(ACTION_HOLDINGS, this.name, this.name, BALANCE_ACTION_WITHDRAW_AMOUNT_PAGE, -1, this::withdraw).handle(open)));</span>
<span class="source-line-no">124</span><span id="line-124">    addPage(balanceWithdrawAmountPage);</span>
<span class="source-line-no">125</span><span id="line-125"></span>
<span class="source-line-no">126</span><span id="line-126">    final Page balanceBreakdownPage = new PageBuilder(BALANCE_BREAKDOWN_PAGE).build();</span>
<span class="source-line-no">127</span><span id="line-127">    balanceBreakdownPage.setOpen(this::handleBreakdownPage);</span>
<span class="source-line-no">128</span><span id="line-128">    addPage(balanceBreakdownPage);</span>
<span class="source-line-no">129</span><span id="line-129"></span>
<span class="source-line-no">130</span><span id="line-130">    final Page balancePayPage = new PageBuilder(BALANCE_PAY_PAGE).build();</span>
<span class="source-line-no">131</span><span id="line-131">    balancePayPage.setOpen((open-&gt;new AccountSelectionPage(ACTION_ACCOUNT_ID, this.name, this.name, BALANCE_PAY_PAGE, BALANCE_PAY_AMOUNT_PAGE, "PAY_ACCOUNT_NAME_SELECTION", this.rows).handle(open)));</span>
<span class="source-line-no">132</span><span id="line-132">    addPage(balancePayPage);</span>
<span class="source-line-no">133</span><span id="line-133"></span>
<span class="source-line-no">134</span><span id="line-134">    final Page balancePayAmountPage = new PageBuilder(BALANCE_PAY_AMOUNT_PAGE).build();</span>
<span class="source-line-no">135</span><span id="line-135">    balancePayAmountPage.setOpen((open-&gt;new MyBalAmountSelectionPage(ACTION_HOLDINGS, this.name, this.name, BALANCE_PAY_AMOUNT_PAGE, -1, this::pay).handle(open)));</span>
<span class="source-line-no">136</span><span id="line-136">    addPage(balancePayAmountPage);</span>
<span class="source-line-no">137</span><span id="line-137"></span>
<span class="source-line-no">138</span><span id="line-138">    final Page noteAmountPage = new PageBuilder(BALANCE_NOTE_AMOUNT_PAGE).build();</span>
<span class="source-line-no">139</span><span id="line-139">    noteAmountPage.setOpen((open-&gt;new MyBalAmountSelectionPage(ACTION_HOLDINGS, this.name, this.name, BALANCE_NOTE_AMOUNT_PAGE, -1, this::note).handle(open)));</span>
<span class="source-line-no">140</span><span id="line-140">    addPage(noteAmountPage);</span>
<span class="source-line-no">141</span><span id="line-141">  }</span>
<span class="source-line-no">142</span><span id="line-142"></span>
<span class="source-line-no">143</span><span id="line-143">  private static Optional&lt;Receipt&gt; processTransaction(final PlayerProvider player, final Transaction transaction, final String modifiedAccount, final BigDecimal modifier) {</span>
<span class="source-line-no">144</span><span id="line-144"></span>
<span class="source-line-no">145</span><span id="line-145">    try {</span>
<span class="source-line-no">146</span><span id="line-146">      final TransactionResult result = transaction.process();</span>
<span class="source-line-no">147</span><span id="line-147"></span>
<span class="source-line-no">148</span><span id="line-148">      if(!result.isSuccessful()) {</span>
<span class="source-line-no">149</span><span id="line-149">        final MessageData data = new MessageData(result.getMessage());</span>
<span class="source-line-no">150</span><span id="line-150">        data.addReplacement("$player", modifiedAccount);</span>
<span class="source-line-no">151</span><span id="line-151">        data.addReplacement("$amount", modifier.toPlainString());</span>
<span class="source-line-no">152</span><span id="line-152"></span>
<span class="source-line-no">153</span><span id="line-153">        player.message(data);</span>
<span class="source-line-no">154</span><span id="line-154">        return Optional.empty();</span>
<span class="source-line-no">155</span><span id="line-155">      }</span>
<span class="source-line-no">156</span><span id="line-156"></span>
<span class="source-line-no">157</span><span id="line-157">      return result.getReceipt();</span>
<span class="source-line-no">158</span><span id="line-158">    } catch(final InvalidTransactionException e) {</span>
<span class="source-line-no">159</span><span id="line-159">      e.printStackTrace();</span>
<span class="source-line-no">160</span><span id="line-160">    }</span>
<span class="source-line-no">161</span><span id="line-161">    return Optional.empty();</span>
<span class="source-line-no">162</span><span id="line-162">  }</span>
<span class="source-line-no">163</span><span id="line-163"></span>
<span class="source-line-no">164</span><span id="line-164">  public void handleMainPage(final PageOpenCallback callback) {</span>
<span class="source-line-no">165</span><span id="line-165"></span>
<span class="source-line-no">166</span><span id="line-166">    final Optional&lt;Account&gt; account = TNECore.eco().account().findAccount(callback.getPlayer().identifier());</span>
<span class="source-line-no">167</span><span id="line-167"></span>
<span class="source-line-no">168</span><span id="line-168">    if(account.isPresent()) {</span>
<span class="source-line-no">169</span><span id="line-169">      int i = 10;</span>
<span class="source-line-no">170</span><span id="line-170">      for(final Currency curObj : TNECore.eco().currency().currencies()) {</span>
<span class="source-line-no">171</span><span id="line-171"></span>
<span class="source-line-no">172</span><span id="line-172">        callback.getPage().addIcon(buildBalanceIcon(i, curObj, account.get()));</span>
<span class="source-line-no">173</span><span id="line-173"></span>
<span class="source-line-no">174</span><span id="line-174">        i += 2;</span>
<span class="source-line-no">175</span><span id="line-175">      }</span>
<span class="source-line-no">176</span><span id="line-176">    }</span>
<span class="source-line-no">177</span><span id="line-177">  }</span>
<span class="source-line-no">178</span><span id="line-178"></span>
<span class="source-line-no">179</span><span id="line-179">  protected void actionsPage(final PageOpenCallback callback) {</span>
<span class="source-line-no">180</span><span id="line-180"></span>
<span class="source-line-no">181</span><span id="line-181">    final Optional&lt;MenuViewer&gt; viewer = callback.getPlayer().viewer();</span>
<span class="source-line-no">182</span><span id="line-182">    if(viewer.isPresent()) {</span>
<span class="source-line-no">183</span><span id="line-183"></span>
<span class="source-line-no">184</span><span id="line-184">      final UUID id = viewer.get().uuid();</span>
<span class="source-line-no">185</span><span id="line-185">      callback.getPage().addIcon(new PreviousPageIcon(id, 0, this.name, 1, ActionType.ANY));</span>
<span class="source-line-no">186</span><span id="line-186"></span>
<span class="source-line-no">187</span><span id="line-187">      final Optional&lt;Account&gt; account = TNECore.eco().account().findAccount(callback.getPlayer().identifier());</span>
<span class="source-line-no">188</span><span id="line-188">      if(account.isPresent()) {</span>
<span class="source-line-no">189</span><span id="line-189"></span>
<span class="source-line-no">190</span><span id="line-190">        final Optional&lt;PlayerProvider&gt; provider = (account.get().isPlayer())? ((PlayerAccount)account.get()).getPlayer() : Optional.empty();</span>
<span class="source-line-no">191</span><span id="line-191"></span>
<span class="source-line-no">192</span><span id="line-192">        final Optional&lt;Object&gt; currencyUUID = viewer.get().findData(ACTION_CURRENCY);</span>
<span class="source-line-no">193</span><span id="line-193">        if(currencyUUID.isPresent()) {</span>
<span class="source-line-no">194</span><span id="line-194"></span>
<span class="source-line-no">195</span><span id="line-195">          final Optional&lt;Currency&gt; currencyOptional = TNECore.eco().currency().find((UUID)currencyUUID.get());</span>
<span class="source-line-no">196</span><span id="line-196">          if(currencyOptional.isPresent()) {</span>
<span class="source-line-no">197</span><span id="line-197">            final UUID currencyID = (UUID)currencyUUID.get();</span>
<span class="source-line-no">198</span><span id="line-198"></span>
<span class="source-line-no">199</span><span id="line-199">            if(!EconomyManager.limitCurrency() || provider.isPresent() &amp;&amp; provider.get().hasPermission("tne.money.from." + currencyID)) {</span>
<span class="source-line-no">200</span><span id="line-200">              callback.getPage().addIcon(new IconBuilder(PluginCore.server().stackBuilder().of("PAPER", 1)</span>
<span class="source-line-no">201</span><span id="line-201">                                                                 .customName(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Actions.ConvertDisplay"), id))</span>
<span class="source-line-no">202</span><span id="line-202">                                                                 .lore(Collections.singletonList(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Actions.Convert"), id))))</span>
<span class="source-line-no">203</span><span id="line-203">                                                 .withSlot(10)</span>
<span class="source-line-no">204</span><span id="line-204">                                                 .withActions(new SwitchPageAction(this.name, BALANCE_ACTION_CONVERT_CURRENCY_PAGE))</span>
<span class="source-line-no">205</span><span id="line-205">                                                 .build());</span>
<span class="source-line-no">206</span><span id="line-206">            }</span>
<span class="source-line-no">207</span><span id="line-207"></span>
<span class="source-line-no">208</span><span id="line-208">            if(currencyOptional.get().type().supportsExchange()) {</span>
<span class="source-line-no">209</span><span id="line-209"></span>
<span class="source-line-no">210</span><span id="line-210">              if(!EconomyManager.limitCurrency() || provider.isPresent() &amp;&amp; provider.get().hasPermission("tne.money.deposit." + currencyID)) {</span>
<span class="source-line-no">211</span><span id="line-211">                callback.getPage().addIcon(new IconBuilder(PluginCore.server().stackBuilder().of("PAPER", 1)</span>
<span class="source-line-no">212</span><span id="line-212">                                                                   .customName(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Actions.DepositDisplay"), id))</span>
<span class="source-line-no">213</span><span id="line-213">                                                                   .lore(Collections.singletonList(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Actions.Deposit"), id))))</span>
<span class="source-line-no">214</span><span id="line-214">                                                   .withSlot(12)</span>
<span class="source-line-no">215</span><span id="line-215">                                                   .withActions(new SwitchPageAction(this.name, BALANCE_ACTION_DEPOSIT_AMOUNT_PAGE))</span>
<span class="source-line-no">216</span><span id="line-216">                                                   .build());</span>
<span class="source-line-no">217</span><span id="line-217">              }</span>
<span class="source-line-no">218</span><span id="line-218"></span>
<span class="source-line-no">219</span><span id="line-219">              if(!EconomyManager.limitCurrency() || provider.isPresent() &amp;&amp; provider.get().hasPermission("tne.money.withdraw." + currencyID)) {</span>
<span class="source-line-no">220</span><span id="line-220">                callback.getPage().addIcon(new IconBuilder(PluginCore.server().stackBuilder().of("PAPER", 1)</span>
<span class="source-line-no">221</span><span id="line-221">                                                                   .customName(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Actions.WithdrawDisplay"), id))</span>
<span class="source-line-no">222</span><span id="line-222">                                                                   .lore(Collections.singletonList(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Actions.Withdraw"), id))))</span>
<span class="source-line-no">223</span><span id="line-223">                                                   .withSlot(14)</span>
<span class="source-line-no">224</span><span id="line-224">                                                   .withActions(new SwitchPageAction(this.name, BALANCE_ACTION_WITHDRAW_AMOUNT_PAGE))</span>
<span class="source-line-no">225</span><span id="line-225">                                                   .build());</span>
<span class="source-line-no">226</span><span id="line-226">              }</span>
<span class="source-line-no">227</span><span id="line-227">            }</span>
<span class="source-line-no">228</span><span id="line-228">          }</span>
<span class="source-line-no">229</span><span id="line-229">        }</span>
<span class="source-line-no">230</span><span id="line-230">      }</span>
<span class="source-line-no">231</span><span id="line-231">    }</span>
<span class="source-line-no">232</span><span id="line-232">  }</span>
<span class="source-line-no">233</span><span id="line-233"></span>
<span class="source-line-no">234</span><span id="line-234">  protected void handleBreakdownPage(final PageOpenCallback callback) {</span>
<span class="source-line-no">235</span><span id="line-235"></span>
<span class="source-line-no">236</span><span id="line-236">    final Optional&lt;MenuViewer&gt; viewer = callback.getPlayer().viewer();</span>
<span class="source-line-no">237</span><span id="line-237">    if(viewer.isPresent()) {</span>
<span class="source-line-no">238</span><span id="line-238"></span>
<span class="source-line-no">239</span><span id="line-239">      final UUID id = viewer.get().uuid();</span>
<span class="source-line-no">240</span><span id="line-240">      callback.getPage().addIcon(new PreviousPageIcon(id, 0, this.name, 1, ActionType.ANY));</span>
<span class="source-line-no">241</span><span id="line-241"></span>
<span class="source-line-no">242</span><span id="line-242">      final Optional&lt;Account&gt; account = TNECore.eco().account().findAccount(callback.getPlayer().identifier());</span>
<span class="source-line-no">243</span><span id="line-243">      if(account.isPresent()) {</span>
<span class="source-line-no">244</span><span id="line-244"></span>
<span class="source-line-no">245</span><span id="line-245">        final Optional&lt;Object&gt; currencyUUID = viewer.get().findData(ACTION_CURRENCY);</span>
<span class="source-line-no">246</span><span id="line-246">        if(currencyUUID.isPresent()) {</span>
<span class="source-line-no">247</span><span id="line-247"></span>
<span class="source-line-no">248</span><span id="line-248">          final Optional&lt;Currency&gt; currencyOptional = TNECore.eco().currency().find((UUID)currencyUUID.get());</span>
<span class="source-line-no">249</span><span id="line-249">          if(currencyOptional.isPresent()) {</span>
<span class="source-line-no">250</span><span id="line-250"></span>
<span class="source-line-no">251</span><span id="line-251">            int i = 10;</span>
<span class="source-line-no">252</span><span id="line-252">            for(final HoldingsEntry entry : account.get().getHoldings(TNECore.eco().region().defaultRegion(), (UUID)currencyUUID.get())) {</span>
<span class="source-line-no">253</span><span id="line-253"></span>
<span class="source-line-no">254</span><span id="line-254">              final MessageData balMessage = new MessageData("Messages.Menu.MyBal.Breakdown.Balance");</span>
<span class="source-line-no">255</span><span id="line-255">              balMessage.addReplacement("$balance", entry.getAmount());</span>
<span class="source-line-no">256</span><span id="line-256"></span>
<span class="source-line-no">257</span><span id="line-257">              callback.getPage().addIcon(new IconBuilder(PluginCore.server().stackBuilder().of("PAPER", 1)</span>
<span class="source-line-no">258</span><span id="line-258">                                                                 .customName(Component.text(entry.getHandler().id()))</span>
<span class="source-line-no">259</span><span id="line-259">                                                                 .lore(Collections.singletonList(MessageHandler.grab(balMessage, id))))</span>
<span class="source-line-no">260</span><span id="line-260">                                                 .withSlot(i).build());</span>
<span class="source-line-no">261</span><span id="line-261">              i += 2;</span>
<span class="source-line-no">262</span><span id="line-262">            }</span>
<span class="source-line-no">263</span><span id="line-263">          }</span>
<span class="source-line-no">264</span><span id="line-264">        }</span>
<span class="source-line-no">265</span><span id="line-265">      }</span>
<span class="source-line-no">266</span><span id="line-266">    }</span>
<span class="source-line-no">267</span><span id="line-267">  }</span>
<span class="source-line-no">268</span><span id="line-268"></span>
<span class="source-line-no">269</span><span id="line-269">  /*</span>
<span class="source-line-no">270</span><span id="line-270">   * Virtual Right click = create note</span>
<span class="source-line-no">271</span><span id="line-271">   */</span>
<span class="source-line-no">272</span><span id="line-272">  protected Icon buildBalanceIcon(final int slot, final Currency currency, final Account account) {</span>
<span class="source-line-no">273</span><span id="line-273"></span>
<span class="source-line-no">274</span><span id="line-274">    final UUID id = account.getIdentifier();</span>
<span class="source-line-no">275</span><span id="line-275"></span>
<span class="source-line-no">276</span><span id="line-276">    final Optional&lt;PlayerProvider&gt; provider = (account.isPlayer())? ((PlayerAccount)account).getPlayer() : Optional.empty();</span>
<span class="source-line-no">277</span><span id="line-277"></span>
<span class="source-line-no">278</span><span id="line-278">    final LinkedList&lt;Component&gt; lore = new LinkedList&lt;&gt;();</span>
<span class="source-line-no">279</span><span id="line-279">    final LinkedList&lt;IconAction&gt; actions = new LinkedList&lt;&gt;();</span>
<span class="source-line-no">280</span><span id="line-280"></span>
<span class="source-line-no">281</span><span id="line-281">    actions.add(new DataAction(ACTION_CURRENCY, currency.getUid()));</span>
<span class="source-line-no">282</span><span id="line-282">    actions.add(new DataAction(ACTION_MAX_HOLDINGS, account.getHoldingsTotal(TNECore.eco().region().defaultRegion(), currency.getUid())));</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">    final MessageData balance = new MessageData("Messages.Menu.MyBal.Main.Balance");</span>
<span class="source-line-no">285</span><span id="line-285"></span>
<span class="source-line-no">286</span><span id="line-286">    final HoldingsEntry entry = new HoldingsEntry(PluginCore.server().defaultWorld(), currency.getUid(),</span>
<span class="source-line-no">287</span><span id="line-287">                                                  account.getHoldingsTotal(TNECore.eco().region().defaultRegion(),</span>
<span class="source-line-no">288</span><span id="line-288">                                                                           currency.getUid()),</span>
<span class="source-line-no">289</span><span id="line-289">                                                  EconomyManager.NORMAL);</span>
<span class="source-line-no">290</span><span id="line-290"></span>
<span class="source-line-no">291</span><span id="line-291">    balance.addReplacement("$balance", CurrencyFormatter.format(account, entry));</span>
<span class="source-line-no">292</span><span id="line-292"></span>
<span class="source-line-no">293</span><span id="line-293">    lore.add(MessageHandler.grab(balance, id));</span>
<span class="source-line-no">294</span><span id="line-294"></span>
<span class="source-line-no">295</span><span id="line-295">    if(!EconomyManager.limitCurrency() || provider.isPresent() &amp;&amp; provider.get().hasPermission("tne.money.pay." + currency.getIdentifier())) {</span>
<span class="source-line-no">296</span><span id="line-296">      lore.add(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Main.Pay"), id));</span>
<span class="source-line-no">297</span><span id="line-297">      actions.add(new SwitchPageAction(this.name, BALANCE_PAY_PAGE, ActionType.LEFT_CLICK));</span>
<span class="source-line-no">298</span><span id="line-298">    }</span>
<span class="source-line-no">299</span><span id="line-299"></span>
<span class="source-line-no">300</span><span id="line-300">    //Drop Action(Other Currency Actions)</span>
<span class="source-line-no">301</span><span id="line-301">    lore.add(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Main.Other"), id));</span>
<span class="source-line-no">302</span><span id="line-302">    actions.add(new SwitchPageAction(this.name, BALANCE_ACTIONS_PAGE, ActionType.DROP));</span>
<span class="source-line-no">303</span><span id="line-303"></span>
<span class="source-line-no">304</span><span id="line-304">    if(currency.type() instanceof VirtualType &amp;&amp; currency.isNotable()) {</span>
<span class="source-line-no">305</span><span id="line-305">      if(!EconomyManager.limitCurrency() || provider.isPresent() &amp;&amp; provider.get().hasPermission("tne.money.pay." + currency.getIdentifier())) {</span>
<span class="source-line-no">306</span><span id="line-306">        lore.add(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Main.Note"), id));</span>
<span class="source-line-no">307</span><span id="line-307">        actions.add(new SwitchPageAction(this.name, BALANCE_NOTE_AMOUNT_PAGE, ActionType.RIGHT_CLICK));</span>
<span class="source-line-no">308</span><span id="line-308">      }</span>
<span class="source-line-no">309</span><span id="line-309">    }</span>
<span class="source-line-no">310</span><span id="line-310"></span>
<span class="source-line-no">311</span><span id="line-311">    if(currency.type().supportsItems()) {</span>
<span class="source-line-no">312</span><span id="line-312">      lore.add(MessageHandler.grab(new MessageData("Messages.Menu.MyBal.Main.Breakdown"), id));</span>
<span class="source-line-no">313</span><span id="line-313">      actions.add(new SwitchPageAction(this.name, BALANCE_BREAKDOWN_PAGE, ActionType.RIGHT_CLICK));</span>
<span class="source-line-no">314</span><span id="line-314">    }</span>
<span class="source-line-no">315</span><span id="line-315"></span>
<span class="source-line-no">316</span><span id="line-316">    return new IconBuilder(PluginCore.server().stackBuilder().of(currency.getIconMaterial(), 1)</span>
<span class="source-line-no">317</span><span id="line-317">                                   .customName(Component.text(currency.getIdentifier())).lore(lore))</span>
<span class="source-line-no">318</span><span id="line-318">            .withSlot(slot)</span>
<span class="source-line-no">319</span><span id="line-319">            .withActions(actions.toArray(new IconAction[actions.size()])).build();</span>
<span class="source-line-no">320</span><span id="line-320">  }</span>
<span class="source-line-no">321</span><span id="line-321"></span>
<span class="source-line-no">322</span><span id="line-322">  /*</span>
<span class="source-line-no">323</span><span id="line-323">   * Our transaction methods.</span>
<span class="source-line-no">324</span><span id="line-324">   * TODO: Make this and the methods in our command handler into one somehow...</span>
<span class="source-line-no">325</span><span id="line-325">   */</span>
<span class="source-line-no">326</span><span id="line-326">  protected void convert(final AmountSelectionHandler handler) {</span>
<span class="source-line-no">327</span><span id="line-327"></span>
<span class="source-line-no">328</span><span id="line-328">    final Optional&lt;MenuViewer&gt; viewer = handler.getClick().player().viewer();</span>
<span class="source-line-no">329</span><span id="line-329">    if(viewer.isPresent()) {</span>
<span class="source-line-no">330</span><span id="line-330">      final UUID playerUUID = viewer.get().uuid();</span>
<span class="source-line-no">331</span><span id="line-331"></span>
<span class="source-line-no">332</span><span id="line-332">      final Optional&lt;Object&gt; currencyUUID = viewer.get().findData(ACTION_CURRENCY);</span>
<span class="source-line-no">333</span><span id="line-333">      final Optional&lt;Object&gt; currencyConvertUUID = viewer.get().findData(ACTION_CONVERT_CURRENCY);</span>
<span class="source-line-no">334</span><span id="line-334">      final Optional&lt;Object&gt; receiverUUID = viewer.get().findData(ACTION_ACCOUNT_ID + "_ID");</span>
<span class="source-line-no">335</span><span id="line-335">      if(currencyUUID.isPresent() &amp;&amp; currencyConvertUUID.isPresent() &amp;&amp; receiverUUID.isPresent()) {</span>
<span class="source-line-no">336</span><span id="line-336"></span>
<span class="source-line-no">337</span><span id="line-337">        final Optional&lt;Currency&gt; fromCurrency = TNECore.eco().currency().find((UUID)currencyConvertUUID.get());</span>
<span class="source-line-no">338</span><span id="line-338">        final Optional&lt;Currency&gt; currencyOptional = TNECore.eco().currency().find((UUID)currencyUUID.get());</span>
<span class="source-line-no">339</span><span id="line-339">        final Optional&lt;PlayerProvider&gt; player = PluginCore.server().findPlayer(handler.getClick().player().identifier());</span>
<span class="source-line-no">340</span><span id="line-340">        if(currencyOptional.isPresent() &amp;&amp; fromCurrency.isPresent() &amp;&amp; player.isPresent()) {</span>
<span class="source-line-no">341</span><span id="line-341"></span>
<span class="source-line-no">342</span><span id="line-342">          if(EconomyManager.limitCurrency()) {</span>
<span class="source-line-no">343</span><span id="line-343">            if(!player.get().hasPermission("tne.money.convert.to." + currencyOptional.get().getIdentifier())) {</span>
<span class="source-line-no">344</span><span id="line-344">              final MessageData data = new MessageData("Messages.Account.BlockedAction");</span>
<span class="source-line-no">345</span><span id="line-345">              data.addReplacement("$action", "convert to");</span>
<span class="source-line-no">346</span><span id="line-346">              data.addReplacement("$currency", currencyOptional.get().getDisplay());</span>
<span class="source-line-no">347</span><span id="line-347">              player.get().message(data);</span>
<span class="source-line-no">348</span><span id="line-348">              return;</span>
<span class="source-line-no">349</span><span id="line-349">            }</span>
<span class="source-line-no">350</span><span id="line-350"></span>
<span class="source-line-no">351</span><span id="line-351">            if(!player.get().hasPermission("tne.money.convert.from." + fromCurrency.get().getIdentifier())) {</span>
<span class="source-line-no">352</span><span id="line-352">              final MessageData data = new MessageData("Messages.Account.BlockedAction");</span>
<span class="source-line-no">353</span><span id="line-353">              data.addReplacement("$action", "convert from");</span>
<span class="source-line-no">354</span><span id="line-354">              data.addReplacement("$currency", fromCurrency.get().getDisplay());</span>
<span class="source-line-no">355</span><span id="line-355">              player.get().message(data);</span>
<span class="source-line-no">356</span><span id="line-356">              return;</span>
<span class="source-line-no">357</span><span id="line-357">            }</span>
<span class="source-line-no">358</span><span id="line-358">          }</span>
<span class="source-line-no">359</span><span id="line-359"></span>
<span class="source-line-no">360</span><span id="line-360">          if(handler.getAmount().compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="source-line-no">361</span><span id="line-361">            player.get().message(new MessageData("Messages.Money.Negative"));</span>
<span class="source-line-no">362</span><span id="line-362">            return;</span>
<span class="source-line-no">363</span><span id="line-363">          }</span>
<span class="source-line-no">364</span><span id="line-364"></span>
<span class="source-line-no">365</span><span id="line-365">          if(currencyOptional.get().getUid().equals(fromCurrency.get().getUid())) {</span>
<span class="source-line-no">366</span><span id="line-366">            player.get().message(new MessageData("Messages.Money.ConvertSame"));</span>
<span class="source-line-no">367</span><span id="line-367">            return;</span>
<span class="source-line-no">368</span><span id="line-368">          }</span>
<span class="source-line-no">369</span><span id="line-369"></span>
<span class="source-line-no">370</span><span id="line-370">          final Optional&lt;Account&gt; senderAccount = TNECore.eco().account().findAccount(playerUUID);</span>
<span class="source-line-no">371</span><span id="line-371">          if(senderAccount.isEmpty()) {</span>
<span class="source-line-no">372</span><span id="line-372">            final MessageData data = new MessageData("Messages.General.NoPlayer");</span>
<span class="source-line-no">373</span><span id="line-373">            data.addReplacement("$player", player.get().getName());</span>
<span class="source-line-no">374</span><span id="line-374">            player.get().message(data);</span>
<span class="source-line-no">375</span><span id="line-375">            return;</span>
<span class="source-line-no">376</span><span id="line-376">          }</span>
<span class="source-line-no">377</span><span id="line-377"></span>
<span class="source-line-no">378</span><span id="line-378">          final Optional&lt;BigDecimal&gt; converted = fromCurrency.get().convertValue(currencyOptional.get().getIdentifier(), handler.getAmount());</span>
<span class="source-line-no">379</span><span id="line-379">          if(converted.isEmpty()) {</span>
<span class="source-line-no">380</span><span id="line-380">            final MessageData data = new MessageData("Messages.Money.NoConversion");</span>
<span class="source-line-no">381</span><span id="line-381">            data.addReplacement("$converted", currencyOptional.get().getIdentifier());</span>
<span class="source-line-no">382</span><span id="line-382">            player.get().message(data);</span>
<span class="source-line-no">383</span><span id="line-383">            return;</span>
<span class="source-line-no">384</span><span id="line-384">          }</span>
<span class="source-line-no">385</span><span id="line-385"></span>
<span class="source-line-no">386</span><span id="line-386">          final String region = "";</span>
<span class="source-line-no">387</span><span id="line-387">          final HoldingsModifier modifier = new HoldingsModifier(region,</span>
<span class="source-line-no">388</span><span id="line-388">                                                                 currencyOptional.get().getUid(),</span>
<span class="source-line-no">389</span><span id="line-389">                                                                 converted.get().setScale(currencyOptional.get().getDecimalPlaces(), RoundingMode.DOWN)</span>
<span class="source-line-no">390</span><span id="line-390">          );</span>
<span class="source-line-no">391</span><span id="line-391"></span>
<span class="source-line-no">392</span><span id="line-392">          final HoldingsModifier modifierFrom = new HoldingsModifier(region,</span>
<span class="source-line-no">393</span><span id="line-393">                                                                     fromCurrency.get().getUid(),</span>
<span class="source-line-no">394</span><span id="line-394">                                                                     handler.getAmount().setScale(currencyOptional.get().getDecimalPlaces(), RoundingMode.DOWN).negate()</span>
<span class="source-line-no">395</span><span id="line-395">          );</span>
<span class="source-line-no">396</span><span id="line-396"></span>
<span class="source-line-no">397</span><span id="line-397">          final Transaction transaction = new Transaction("convert")</span>
<span class="source-line-no">398</span><span id="line-398">                  .from(senderAccount.get(), modifierFrom)</span>
<span class="source-line-no">399</span><span id="line-399">                  .to(senderAccount.get(), modifier)</span>
<span class="source-line-no">400</span><span id="line-400">                  .processor(EconomyManager.baseProcessor())</span>
<span class="source-line-no">401</span><span id="line-401">                  .source(new PlayerSource(playerUUID));</span>
<span class="source-line-no">402</span><span id="line-402"></span>
<span class="source-line-no">403</span><span id="line-403">          final Optional&lt;Receipt&gt; receipt = processTransaction(player.get(), transaction, senderAccount.get().getName(), handler.getAmount());</span>
<span class="source-line-no">404</span><span id="line-404">          if(receipt.isPresent()) {</span>
<span class="source-line-no">405</span><span id="line-405">            final MessageData data = new MessageData("Messages.Money.Converted");</span>
<span class="source-line-no">406</span><span id="line-406">            data.addReplacement("$from_amount", handler.getAmount().toPlainString());</span>
<span class="source-line-no">407</span><span id="line-407">            data.addReplacement("$amount", CurrencyFormatter.format(senderAccount.get(),</span>
<span class="source-line-no">408</span><span id="line-408">                                                                    modifierFrom.asEntry()));</span>
<span class="source-line-no">409</span><span id="line-409">            player.get().message(data);</span>
<span class="source-line-no">410</span><span id="line-410">          }</span>
<span class="source-line-no">411</span><span id="line-411">        }</span>
<span class="source-line-no">412</span><span id="line-412">      }</span>
<span class="source-line-no">413</span><span id="line-413">    }</span>
<span class="source-line-no">414</span><span id="line-414">  }</span>
<span class="source-line-no">415</span><span id="line-415"></span>
<span class="source-line-no">416</span><span id="line-416">  protected void deposit(final AmountSelectionHandler handler) {</span>
<span class="source-line-no">417</span><span id="line-417"></span>
<span class="source-line-no">418</span><span id="line-418">    final Optional&lt;MenuViewer&gt; viewer = handler.getClick().player().viewer();</span>
<span class="source-line-no">419</span><span id="line-419">    if(viewer.isPresent()) {</span>
<span class="source-line-no">420</span><span id="line-420">      final UUID playerUUID = viewer.get().uuid();</span>
<span class="source-line-no">421</span><span id="line-421"></span>
<span class="source-line-no">422</span><span id="line-422">      final Optional&lt;Object&gt; currencyUUID = viewer.get().findData(ACTION_CURRENCY);</span>
<span class="source-line-no">423</span><span id="line-423">      final Optional&lt;Object&gt; receiverUUID = viewer.get().findData(ACTION_ACCOUNT_ID + "_ID");</span>
<span class="source-line-no">424</span><span id="line-424">      if(currencyUUID.isPresent() &amp;&amp; receiverUUID.isPresent()) {</span>
<span class="source-line-no">425</span><span id="line-425"></span>
<span class="source-line-no">426</span><span id="line-426">        final Optional&lt;Currency&gt; currencyOptional = TNECore.eco().currency().find((UUID)currencyUUID.get());</span>
<span class="source-line-no">427</span><span id="line-427">        final Optional&lt;PlayerProvider&gt; player = PluginCore.server().findPlayer(handler.getClick().player().identifier());</span>
<span class="source-line-no">428</span><span id="line-428">        if(currencyOptional.isPresent() &amp;&amp; player.isPresent()) {</span>
<span class="source-line-no">429</span><span id="line-429"></span>
<span class="source-line-no">430</span><span id="line-430">          if(EconomyManager.limitCurrency()) {</span>
<span class="source-line-no">431</span><span id="line-431">            if(!player.get().hasPermission("tne.money.deposit." + currencyOptional.get().getIdentifier())) {</span>
<span class="source-line-no">432</span><span id="line-432">              final MessageData data = new MessageData("Messages.Account.BlockedAction");</span>
<span class="source-line-no">433</span><span id="line-433">              data.addReplacement("$action", "deposit");</span>
<span class="source-line-no">434</span><span id="line-434">              data.addReplacement("$currency", currencyOptional.get().getDisplay());</span>
<span class="source-line-no">435</span><span id="line-435">              player.get().message(data);</span>
<span class="source-line-no">436</span><span id="line-436">              return;</span>
<span class="source-line-no">437</span><span id="line-437">            }</span>
<span class="source-line-no">438</span><span id="line-438">          }</span>
<span class="source-line-no">439</span><span id="line-439"></span>
<span class="source-line-no">440</span><span id="line-440">          if(handler.getAmount().compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="source-line-no">441</span><span id="line-441">            player.get().message(new MessageData("Messages.Money.Negative"));</span>
<span class="source-line-no">442</span><span id="line-442">            return;</span>
<span class="source-line-no">443</span><span id="line-443">          }</span>
<span class="source-line-no">444</span><span id="line-444"></span>
<span class="source-line-no">445</span><span id="line-445">          final Optional&lt;Account&gt; senderAccount = TNECore.eco().account().findAccount(playerUUID);</span>
<span class="source-line-no">446</span><span id="line-446">          if(senderAccount.isEmpty()) {</span>
<span class="source-line-no">447</span><span id="line-447">            final MessageData data = new MessageData("Messages.General.NoPlayer");</span>
<span class="source-line-no">448</span><span id="line-448">            data.addReplacement("$player", player.get().getName());</span>
<span class="source-line-no">449</span><span id="line-449">            player.get().message(data);</span>
<span class="source-line-no">450</span><span id="line-450">            return;</span>
<span class="source-line-no">451</span><span id="line-451">          }</span>
<span class="source-line-no">452</span><span id="line-452"></span>
<span class="source-line-no">453</span><span id="line-453">          if(!(currencyOptional.get().type() instanceof MixedType)) {</span>
<span class="source-line-no">454</span><span id="line-454">            player.get().message(new MessageData("Messages.Money.NotMixed"));</span>
<span class="source-line-no">455</span><span id="line-455">            return;</span>
<span class="source-line-no">456</span><span id="line-456">          }</span>
<span class="source-line-no">457</span><span id="line-457"></span>
<span class="source-line-no">458</span><span id="line-458">          final HoldingsModifier modifier = new HoldingsModifier(TNECore.eco().region().getMode().region(player.get()),</span>
<span class="source-line-no">459</span><span id="line-459">                                                                 currencyOptional.get().getUid(),</span>
<span class="source-line-no">460</span><span id="line-460">                                                                 handler.getAmount(),</span>
<span class="source-line-no">461</span><span id="line-461">                                                                 EconomyManager.VIRTUAL</span>
<span class="source-line-no">462</span><span id="line-462">          );</span>
<span class="source-line-no">463</span><span id="line-463"></span>
<span class="source-line-no">464</span><span id="line-464">          final Transaction transaction = new Transaction("deposit")</span>
<span class="source-line-no">465</span><span id="line-465">                  .to(senderAccount.get(), modifier)</span>
<span class="source-line-no">466</span><span id="line-466">                  .from(senderAccount.get(), modifier.counter(EconomyManager.ITEM_ONLY))</span>
<span class="source-line-no">467</span><span id="line-467">                  .processor(EconomyManager.baseProcessor())</span>
<span class="source-line-no">468</span><span id="line-468">                  .source(new PlayerSource(playerUUID));</span>
<span class="source-line-no">469</span><span id="line-469"></span>
<span class="source-line-no">470</span><span id="line-470">          final Optional&lt;Receipt&gt; receipt = processTransaction(player.get(), transaction, senderAccount.get().getName(), handler.getAmount());</span>
<span class="source-line-no">471</span><span id="line-471">          if(receipt.isPresent()) {</span>
<span class="source-line-no">472</span><span id="line-472">            final MessageData data = new MessageData("Messages.Money.Deposit");</span>
<span class="source-line-no">473</span><span id="line-473">            data.addReplacement("$amount", CurrencyFormatter.format(senderAccount.get(),</span>
<span class="source-line-no">474</span><span id="line-474">                                                                    modifier.asEntry()));</span>
<span class="source-line-no">475</span><span id="line-475">            player.get().message(data);</span>
<span class="source-line-no">476</span><span id="line-476">          }</span>
<span class="source-line-no">477</span><span id="line-477">        }</span>
<span class="source-line-no">478</span><span id="line-478">      }</span>
<span class="source-line-no">479</span><span id="line-479">    }</span>
<span class="source-line-no">480</span><span id="line-480">  }</span>
<span class="source-line-no">481</span><span id="line-481"></span>
<span class="source-line-no">482</span><span id="line-482">  protected void note(final AmountSelectionHandler handler) {</span>
<span class="source-line-no">483</span><span id="line-483"></span>
<span class="source-line-no">484</span><span id="line-484">    final Optional&lt;MenuViewer&gt; viewer = handler.getClick().player().viewer();</span>
<span class="source-line-no">485</span><span id="line-485">    if(viewer.isPresent()) {</span>
<span class="source-line-no">486</span><span id="line-486">      final UUID playerUUID = viewer.get().uuid();</span>
<span class="source-line-no">487</span><span id="line-487"></span>
<span class="source-line-no">488</span><span id="line-488">      final Optional&lt;Object&gt; currencyUUID = viewer.get().findData(ACTION_CURRENCY);</span>
<span class="source-line-no">489</span><span id="line-489">      final Optional&lt;Object&gt; receiverUUID = viewer.get().findData(ACTION_ACCOUNT_ID + "_ID");</span>
<span class="source-line-no">490</span><span id="line-490">      if(currencyUUID.isPresent() &amp;&amp; receiverUUID.isPresent()) {</span>
<span class="source-line-no">491</span><span id="line-491"></span>
<span class="source-line-no">492</span><span id="line-492">        final Optional&lt;Currency&gt; currencyOptional = TNECore.eco().currency().find((UUID)currencyUUID.get());</span>
<span class="source-line-no">493</span><span id="line-493">        final Optional&lt;PlayerProvider&gt; player = PluginCore.server().findPlayer(handler.getClick().player().identifier());</span>
<span class="source-line-no">494</span><span id="line-494">        final Optional&lt;Account&gt; account = TNECore.eco().account().findAccount(playerUUID);</span>
<span class="source-line-no">495</span><span id="line-495">        if(currencyOptional.isPresent() &amp;&amp; player.isPresent() &amp;&amp; account.isPresent()) {</span>
<span class="source-line-no">496</span><span id="line-496"></span>
<span class="source-line-no">497</span><span id="line-497">          final Optional&lt;Note&gt; note = currencyOptional.get().getNote();</span>
<span class="source-line-no">498</span><span id="line-498">          if(note.isPresent() &amp;&amp; account.get() instanceof PlayerAccount) {</span>
<span class="source-line-no">499</span><span id="line-499"></span>
<span class="source-line-no">500</span><span id="line-500">            final String region = TNECore.eco().region().getMode().region(player.get());</span>
<span class="source-line-no">501</span><span id="line-501"></span>
<span class="source-line-no">502</span><span id="line-502">            if(EconomyManager.limitCurrency() &amp;&amp; !player.get().hasPermission("tne.money.note." + currencyOptional.get().getIdentifier())) {</span>
<span class="source-line-no">503</span><span id="line-503">              final MessageData data = new MessageData("Messages.Account.BlockedAction");</span>
<span class="source-line-no">504</span><span id="line-504">              data.addReplacement("$action", "note");</span>
<span class="source-line-no">505</span><span id="line-505">              data.addReplacement("$currency", currencyOptional.get().getDisplay());</span>
<span class="source-line-no">506</span><span id="line-506">              player.get().message(data);</span>
<span class="source-line-no">507</span><span id="line-507">              return;</span>
<span class="source-line-no">508</span><span id="line-508">            }</span>
<span class="source-line-no">509</span><span id="line-509"></span>
<span class="source-line-no">510</span><span id="line-510">            if(handler.getAmount().compareTo(note.get().getMinimum()) &lt; 0) {</span>
<span class="source-line-no">511</span><span id="line-511">              final MessageData min = new MessageData("Messages.Note.Minimum");</span>
<span class="source-line-no">512</span><span id="line-512">              min.addReplacement("$amount", note.get().getMinimum().toPlainString());</span>
<span class="source-line-no">513</span><span id="line-513">              player.get().message(min);</span>
<span class="source-line-no">514</span><span id="line-514">              return;</span>
<span class="source-line-no">515</span><span id="line-515">            }</span>
<span class="source-line-no">516</span><span id="line-516"></span>
<span class="source-line-no">517</span><span id="line-517">            final BigDecimal rounded = handler.getAmount().setScale(currencyOptional.get().getDecimalPlaces(), RoundingMode.DOWN);</span>
<span class="source-line-no">518</span><span id="line-518"></span>
<span class="source-line-no">519</span><span id="line-519">            final BigDecimal amt = rounded.add(note.get().getFee().calculateTax(rounded)).setScale(currencyOptional.get().getDecimalPlaces(), RoundingMode.DOWN);</span>
<span class="source-line-no">520</span><span id="line-520"></span>
<span class="source-line-no">521</span><span id="line-521">            final HoldingsModifier modifier = new HoldingsModifier(region,</span>
<span class="source-line-no">522</span><span id="line-522">                                                                   currencyOptional.get().getUid(),</span>
<span class="source-line-no">523</span><span id="line-523">                                                                   amt</span>
<span class="source-line-no">524</span><span id="line-524">            );</span>
<span class="source-line-no">525</span><span id="line-525"></span>
<span class="source-line-no">526</span><span id="line-526">            final Transaction transaction = new Transaction("note")</span>
<span class="source-line-no">527</span><span id="line-527">                    .from(account.get(), modifier.counter())</span>
<span class="source-line-no">528</span><span id="line-528">                    .processor(EconomyManager.baseProcessor())</span>
<span class="source-line-no">529</span><span id="line-529">                    .source(new PlayerSource(playerUUID));</span>
<span class="source-line-no">530</span><span id="line-530"></span>
<span class="source-line-no">531</span><span id="line-531"></span>
<span class="source-line-no">532</span><span id="line-532">            final Optional&lt;Receipt&gt; receipt = processTransaction(player.get(), transaction, account.get().getName(), handler.getAmount());</span>
<span class="source-line-no">533</span><span id="line-533">            if(receipt.isPresent()) {</span>
<span class="source-line-no">534</span><span id="line-534">              final Collection&lt;AbstractItemStack&lt;Object&gt;&gt; left = PluginCore.server().calculations().giveItems(Collections.singletonList(note.get().stack(currencyOptional.get().getIdentifier(), region, rounded)),</span>
<span class="source-line-no">535</span><span id="line-535">                                                                                                              player.get().inventory().getInventory(false));</span>
<span class="source-line-no">536</span><span id="line-536"></span>
<span class="source-line-no">537</span><span id="line-537">              if(!left.isEmpty()) {</span>
<span class="source-line-no">538</span><span id="line-538">                PluginCore.server().calculations().drop(left, ((PlayerAccount)account.get()).getUUID(), true);</span>
<span class="source-line-no">539</span><span id="line-539">              }</span>
<span class="source-line-no">540</span><span id="line-540"></span>
<span class="source-line-no">541</span><span id="line-541">              final MessageData entryMSG = new MessageData("Messages.Note.Given");</span>
<span class="source-line-no">542</span><span id="line-542">              entryMSG.addReplacement("$currency", currencyOptional.get().getIdentifier());</span>
<span class="source-line-no">543</span><span id="line-543">              entryMSG.addReplacement("$amount", CurrencyFormatter.format(account.get(), modifier.asEntry()));</span>
<span class="source-line-no">544</span><span id="line-544">              player.get().message(entryMSG);</span>
<span class="source-line-no">545</span><span id="line-545">            }</span>
<span class="source-line-no">546</span><span id="line-546">          }</span>
<span class="source-line-no">547</span><span id="line-547">        }</span>
<span class="source-line-no">548</span><span id="line-548">      }</span>
<span class="source-line-no">549</span><span id="line-549">    }</span>
<span class="source-line-no">550</span><span id="line-550">  }</span>
<span class="source-line-no">551</span><span id="line-551"></span>
<span class="source-line-no">552</span><span id="line-552">  protected void pay(final AmountSelectionHandler handler) {</span>
<span class="source-line-no">553</span><span id="line-553"></span>
<span class="source-line-no">554</span><span id="line-554">    final Optional&lt;MenuViewer&gt; viewer = handler.getClick().player().viewer();</span>
<span class="source-line-no">555</span><span id="line-555">    if(viewer.isPresent()) {</span>
<span class="source-line-no">556</span><span id="line-556">      final UUID playerUUID = viewer.get().uuid();</span>
<span class="source-line-no">557</span><span id="line-557"></span>
<span class="source-line-no">558</span><span id="line-558">      final Optional&lt;Object&gt; currencyUUID = viewer.get().findData(ACTION_CURRENCY);</span>
<span class="source-line-no">559</span><span id="line-559">      final Optional&lt;Object&gt; receiverUUID = viewer.get().findData(ACTION_ACCOUNT_ID + "_ID");</span>
<span class="source-line-no">560</span><span id="line-560">      if(currencyUUID.isPresent() &amp;&amp; receiverUUID.isPresent()) {</span>
<span class="source-line-no">561</span><span id="line-561"></span>
<span class="source-line-no">562</span><span id="line-562">        final Optional&lt;Currency&gt; currencyOptional = TNECore.eco().currency().find((UUID)currencyUUID.get());</span>
<span class="source-line-no">563</span><span id="line-563">        final Optional&lt;PlayerProvider&gt; player = PluginCore.server().findPlayer(handler.getClick().player().identifier());</span>
<span class="source-line-no">564</span><span id="line-564">        if(currencyOptional.isPresent() &amp;&amp; player.isPresent()) {</span>
<span class="source-line-no">565</span><span id="line-565"></span>
<span class="source-line-no">566</span><span id="line-566">          //Our receiving account</span>
<span class="source-line-no">567</span><span id="line-567">          final Optional&lt;Account&gt; account = TNECore.eco().account().findAccount(UUID.fromString((String)receiverUUID.get()));</span>
<span class="source-line-no">568</span><span id="line-568">          if(account.isPresent()) {</span>
<span class="source-line-no">569</span><span id="line-569"></span>
<span class="source-line-no">570</span><span id="line-570">            if(EconomyManager.limitCurrency()) {</span>
<span class="source-line-no">571</span><span id="line-571">              if(!player.get().hasPermission("tne.money.pay." + currencyOptional.get().getIdentifier())) {</span>
<span class="source-line-no">572</span><span id="line-572">                final MessageData data = new MessageData("Messages.Account.BlockedAction");</span>
<span class="source-line-no">573</span><span id="line-573">                data.addReplacement("$action", "pay");</span>
<span class="source-line-no">574</span><span id="line-574">                data.addReplacement("$currency", currencyOptional.get().getDisplay());</span>
<span class="source-line-no">575</span><span id="line-575">                player.get().message(data);</span>
<span class="source-line-no">576</span><span id="line-576">                return;</span>
<span class="source-line-no">577</span><span id="line-577">              }</span>
<span class="source-line-no">578</span><span id="line-578">            }</span>
<span class="source-line-no">579</span><span id="line-579"></span>
<span class="source-line-no">580</span><span id="line-580">            if(handler.getAmount().compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="source-line-no">581</span><span id="line-581">              player.get().message(new MessageData("Messages.Money.Negative"));</span>
<span class="source-line-no">582</span><span id="line-582">              return;</span>
<span class="source-line-no">583</span><span id="line-583">            }</span>
<span class="source-line-no">584</span><span id="line-584"></span>
<span class="source-line-no">585</span><span id="line-585">            final Optional&lt;Account&gt; senderAccount = TNECore.eco().account().findAccount(playerUUID);</span>
<span class="source-line-no">586</span><span id="line-586">            if(senderAccount.isEmpty()) {</span>
<span class="source-line-no">587</span><span id="line-587">              final MessageData data = new MessageData("Messages.General.NoPlayer");</span>
<span class="source-line-no">588</span><span id="line-588">              data.addReplacement("$player", player.get().getName());</span>
<span class="source-line-no">589</span><span id="line-589">              player.get().message(data);</span>
<span class="source-line-no">590</span><span id="line-590">              return;</span>
<span class="source-line-no">591</span><span id="line-591">            }</span>
<span class="source-line-no">592</span><span id="line-592"></span>
<span class="source-line-no">593</span><span id="line-593">            if(senderAccount.get().getIdentifier().equals(account.get().getIdentifier())) {</span>
<span class="source-line-no">594</span><span id="line-594">              final MessageData data = new MessageData("Messages.Money.SelfPay");</span>
<span class="source-line-no">595</span><span id="line-595">              data.addReplacement("$player", player.get().getName());</span>
<span class="source-line-no">596</span><span id="line-596">              player.get().message(data);</span>
<span class="source-line-no">597</span><span id="line-597">              return;</span>
<span class="source-line-no">598</span><span id="line-598">            }</span>
<span class="source-line-no">599</span><span id="line-599"></span>
<span class="source-line-no">600</span><span id="line-600">            if(!MainConfig.yaml().getBoolean("Core.Commands.Pay.Offline", true)) {</span>
<span class="source-line-no">601</span><span id="line-601">              if(!(account.get() instanceof PlayerAccount) || !((PlayerAccount)account.get()).isOnline()) {</span>
<span class="source-line-no">602</span><span id="line-602"></span>
<span class="source-line-no">603</span><span id="line-603">                player.get().message(new MessageData("Messages.Money.PayFailedOnline"));</span>
<span class="source-line-no">604</span><span id="line-604">                return;</span>
<span class="source-line-no">605</span><span id="line-605">              }</span>
<span class="source-line-no">606</span><span id="line-606">            }</span>
<span class="source-line-no">607</span><span id="line-607"></span>
<span class="source-line-no">608</span><span id="line-608">            if(MainConfig.yaml().getInt("Core.Commands.Pay.Radius", 0) &gt; 0) {</span>
<span class="source-line-no">609</span><span id="line-609">              final MessageData data = new MessageData("Messages.Money.PayFailedDistance");</span>
<span class="source-line-no">610</span><span id="line-610">              data.addReplacement("$distance", String.valueOf(MainConfig.yaml().getInt("Core.Commands.Pay.Radius")));</span>
<span class="source-line-no">611</span><span id="line-611"></span>
<span class="source-line-no">612</span><span id="line-612">              if(!(senderAccount.get() instanceof PlayerAccount) || !((PlayerAccount)senderAccount.get()).isOnline()</span>
<span class="source-line-no">613</span><span id="line-613">                 || !(account.get() instanceof PlayerAccount) || !((PlayerAccount)account.get()).isOnline()) {</span>
<span class="source-line-no">614</span><span id="line-614">                player.get().message(data);</span>
<span class="source-line-no">615</span><span id="line-615">                return;</span>
<span class="source-line-no">616</span><span id="line-616">              }</span>
<span class="source-line-no">617</span><span id="line-617"></span>
<span class="source-line-no">618</span><span id="line-618">              final Optional&lt;PlayerProvider&gt; senderPlayer = ((PlayerAccount)senderAccount.get()).getPlayer();</span>
<span class="source-line-no">619</span><span id="line-619">              final Optional&lt;PlayerProvider&gt; playerPlayer = ((PlayerAccount)account.get()).getPlayer();</span>
<span class="source-line-no">620</span><span id="line-620">              if(senderPlayer.isEmpty() || playerPlayer.isEmpty()</span>
<span class="source-line-no">621</span><span id="line-621">                 || senderPlayer.get().getLocation().isEmpty() || playerPlayer.get().getLocation().isEmpty()) {</span>
<span class="source-line-no">622</span><span id="line-622">                player.get().message(data);</span>
<span class="source-line-no">623</span><span id="line-623">                return;</span>
<span class="source-line-no">624</span><span id="line-624">              }</span>
<span class="source-line-no">625</span><span id="line-625"></span>
<span class="source-line-no">626</span><span id="line-626">              if(senderPlayer.get().getLocation().get().distance(playerPlayer.get().getLocation().get()) &gt; MainConfig.yaml().getInt("Core.Commands.Pay.Radius")) {</span>
<span class="source-line-no">627</span><span id="line-627">                player.get().message(data);</span>
<span class="source-line-no">628</span><span id="line-628">                return;</span>
<span class="source-line-no">629</span><span id="line-629">              }</span>
<span class="source-line-no">630</span><span id="line-630">            }</span>
<span class="source-line-no">631</span><span id="line-631"></span>
<span class="source-line-no">632</span><span id="line-632">            final HoldingsModifier modifier = new HoldingsModifier(TNECore.eco().region().getMode().region(player.get()),</span>
<span class="source-line-no">633</span><span id="line-633">                                                                   currencyOptional.get().getUid(),</span>
<span class="source-line-no">634</span><span id="line-634">                                                                   handler.getAmount()</span>
<span class="source-line-no">635</span><span id="line-635">            );</span>
<span class="source-line-no">636</span><span id="line-636">            final Transaction transaction = new Transaction("pay")</span>
<span class="source-line-no">637</span><span id="line-637">                    .to(account.get(), modifier)</span>
<span class="source-line-no">638</span><span id="line-638">                    .from(senderAccount.get(), modifier.counter())</span>
<span class="source-line-no">639</span><span id="line-639">                    .processor(EconomyManager.baseProcessor())</span>
<span class="source-line-no">640</span><span id="line-640">                    .source(new PlayerSource(playerUUID));</span>
<span class="source-line-no">641</span><span id="line-641"></span>
<span class="source-line-no">642</span><span id="line-642">            final Optional&lt;Receipt&gt; receipt = processTransaction(player.get(), transaction, account.get().getName(), handler.getAmount());</span>
<span class="source-line-no">643</span><span id="line-643">            if(receipt.isPresent()) {</span>
<span class="source-line-no">644</span><span id="line-644">              final MessageData data = new MessageData("Messages.Money.Paid");</span>
<span class="source-line-no">645</span><span id="line-645">              data.addReplacement("$player", account.get().getName());</span>
<span class="source-line-no">646</span><span id="line-646">              data.addReplacement("$currency", currencyOptional.get().getIdentifier());</span>
<span class="source-line-no">647</span><span id="line-647">              data.addReplacement("$amount", CurrencyFormatter.format(account.get(),</span>
<span class="source-line-no">648</span><span id="line-648">                                                                      modifier.asEntry()));</span>
<span class="source-line-no">649</span><span id="line-649">              player.get().message(data);</span>
<span class="source-line-no">650</span><span id="line-650"></span>
<span class="source-line-no">651</span><span id="line-651">              if(account.get().isPlayer() &amp;&amp; ((PlayerAccount)account.get()).isOnline()) {</span>
<span class="source-line-no">652</span><span id="line-652"></span>
<span class="source-line-no">653</span><span id="line-653">                final Optional&lt;PlayerProvider&gt; provider = PluginCore.server().findPlayer(((PlayerAccount)account.get()).getUUID());</span>
<span class="source-line-no">654</span><span id="line-654">                if(provider.isPresent()) {</span>
<span class="source-line-no">655</span><span id="line-655"></span>
<span class="source-line-no">656</span><span id="line-656">                  final MessageData msgData = new MessageData("Messages.Money.Received");</span>
<span class="source-line-no">657</span><span id="line-657">                  msgData.addReplacement("$player", (player.get().getName() == null)? MainConfig.yaml().getString("Core.Server.Account.Name") : player.get().getName());</span>
<span class="source-line-no">658</span><span id="line-658">                  msgData.addReplacement("$amount", CurrencyFormatter.format(account.get(),</span>
<span class="source-line-no">659</span><span id="line-659">                                                                             modifier.asEntry()));</span>
<span class="source-line-no">660</span><span id="line-660">                  provider.get().message(msgData);</span>
<span class="source-line-no">661</span><span id="line-661">                }</span>
<span class="source-line-no">662</span><span id="line-662">              }</span>
<span class="source-line-no">663</span><span id="line-663">            }</span>
<span class="source-line-no">664</span><span id="line-664">          }</span>
<span class="source-line-no">665</span><span id="line-665">        }</span>
<span class="source-line-no">666</span><span id="line-666">      }</span>
<span class="source-line-no">667</span><span id="line-667">    }</span>
<span class="source-line-no">668</span><span id="line-668">  }</span>
<span class="source-line-no">669</span><span id="line-669"></span>
<span class="source-line-no">670</span><span id="line-670">  protected void withdraw(final AmountSelectionHandler handler) {</span>
<span class="source-line-no">671</span><span id="line-671"></span>
<span class="source-line-no">672</span><span id="line-672">    final Optional&lt;MenuViewer&gt; viewer = handler.getClick().player().viewer();</span>
<span class="source-line-no">673</span><span id="line-673">    if(viewer.isPresent()) {</span>
<span class="source-line-no">674</span><span id="line-674">      final UUID playerUUID = viewer.get().uuid();</span>
<span class="source-line-no">675</span><span id="line-675"></span>
<span class="source-line-no">676</span><span id="line-676">      final Optional&lt;Object&gt; currencyUUID = viewer.get().findData(ACTION_CURRENCY);</span>
<span class="source-line-no">677</span><span id="line-677">      if(currencyUUID.isPresent()) {</span>
<span class="source-line-no">678</span><span id="line-678"></span>
<span class="source-line-no">679</span><span id="line-679">        final Optional&lt;Currency&gt; currencyOptional = TNECore.eco().currency().find((UUID)currencyUUID.get());</span>
<span class="source-line-no">680</span><span id="line-680">        final Optional&lt;PlayerProvider&gt; player = PluginCore.server().findPlayer(handler.getClick().player().identifier());</span>
<span class="source-line-no">681</span><span id="line-681">        if(currencyOptional.isPresent() &amp;&amp; player.isPresent()) {</span>
<span class="source-line-no">682</span><span id="line-682"></span>
<span class="source-line-no">683</span><span id="line-683">          if(EconomyManager.limitCurrency()) {</span>
<span class="source-line-no">684</span><span id="line-684">            if(!player.get().hasPermission("tne.money.withdraw." + currencyOptional.get().getIdentifier())) {</span>
<span class="source-line-no">685</span><span id="line-685">              final MessageData data = new MessageData("Messages.Account.BlockedAction");</span>
<span class="source-line-no">686</span><span id="line-686">              data.addReplacement("$action", "withdraw funds");</span>
<span class="source-line-no">687</span><span id="line-687">              data.addReplacement("$currency", currencyOptional.get().getDisplay());</span>
<span class="source-line-no">688</span><span id="line-688">              player.get().message(data);</span>
<span class="source-line-no">689</span><span id="line-689">              return;</span>
<span class="source-line-no">690</span><span id="line-690">            }</span>
<span class="source-line-no">691</span><span id="line-691">          }</span>
<span class="source-line-no">692</span><span id="line-692"></span>
<span class="source-line-no">693</span><span id="line-693">          if(handler.getAmount().compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="source-line-no">694</span><span id="line-694">            player.get().message(new MessageData("Messages.Money.Negative"));</span>
<span class="source-line-no">695</span><span id="line-695">            return;</span>
<span class="source-line-no">696</span><span id="line-696">          }</span>
<span class="source-line-no">697</span><span id="line-697"></span>
<span class="source-line-no">698</span><span id="line-698">          final Optional&lt;Account&gt; senderAccount = TNECore.eco().account().findAccount(playerUUID);</span>
<span class="source-line-no">699</span><span id="line-699">          if(senderAccount.isEmpty()) {</span>
<span class="source-line-no">700</span><span id="line-700">            final MessageData data = new MessageData("Messages.General.NoPlayer");</span>
<span class="source-line-no">701</span><span id="line-701">            data.addReplacement("$player", player.get().getName());</span>
<span class="source-line-no">702</span><span id="line-702">            player.get().message(data);</span>
<span class="source-line-no">703</span><span id="line-703">            return;</span>
<span class="source-line-no">704</span><span id="line-704">          }</span>
<span class="source-line-no">705</span><span id="line-705"></span>
<span class="source-line-no">706</span><span id="line-706">          if(!(currencyOptional.get().type() instanceof MixedType)) {</span>
<span class="source-line-no">707</span><span id="line-707">            player.get().message(new MessageData("Messages.Money.NotMixed"));</span>
<span class="source-line-no">708</span><span id="line-708">            return;</span>
<span class="source-line-no">709</span><span id="line-709">          }</span>
<span class="source-line-no">710</span><span id="line-710"></span>
<span class="source-line-no">711</span><span id="line-711">          final HoldingsModifier modifier = new HoldingsModifier(TNECore.eco().region().getMode().region(player.get()),</span>
<span class="source-line-no">712</span><span id="line-712">                                                                 currencyOptional.get().getUid(),</span>
<span class="source-line-no">713</span><span id="line-713">                                                                 handler.getAmount(),</span>
<span class="source-line-no">714</span><span id="line-714">                                                                 EconomyManager.ITEM_ONLY</span>
<span class="source-line-no">715</span><span id="line-715">          );</span>
<span class="source-line-no">716</span><span id="line-716"></span>
<span class="source-line-no">717</span><span id="line-717">          final Transaction transaction = new Transaction("withdraw")</span>
<span class="source-line-no">718</span><span id="line-718">                  .to(senderAccount.get(), modifier)</span>
<span class="source-line-no">719</span><span id="line-719">                  .from(senderAccount.get(), modifier.counter(EconomyManager.VIRTUAL))</span>
<span class="source-line-no">720</span><span id="line-720">                  .processor(EconomyManager.baseProcessor())</span>
<span class="source-line-no">721</span><span id="line-721">                  .source(new PlayerSource(playerUUID));</span>
<span class="source-line-no">722</span><span id="line-722"></span>
<span class="source-line-no">723</span><span id="line-723">          final Optional&lt;Receipt&gt; receipt = processTransaction(player.get(), transaction, senderAccount.get().getName(), handler.getAmount());</span>
<span class="source-line-no">724</span><span id="line-724">          if(receipt.isPresent()) {</span>
<span class="source-line-no">725</span><span id="line-725"></span>
<span class="source-line-no">726</span><span id="line-726">            final MessageData data = new MessageData("Messages.Money.Withdrawn");</span>
<span class="source-line-no">727</span><span id="line-727">            data.addReplacement("$currency", currencyOptional.get().getIdentifier());</span>
<span class="source-line-no">728</span><span id="line-728">            data.addReplacement("$amount", CurrencyFormatter.format(senderAccount.get(),</span>
<span class="source-line-no">729</span><span id="line-729">                                                                    modifier.asEntry()));</span>
<span class="source-line-no">730</span><span id="line-730">            player.get().message(data);</span>
<span class="source-line-no">731</span><span id="line-731">            return;</span>
<span class="source-line-no">732</span><span id="line-732">          }</span>
<span class="source-line-no">733</span><span id="line-733">        }</span>
<span class="source-line-no">734</span><span id="line-734">      }</span>
<span class="source-line-no">735</span><span id="line-735">    }</span>
<span class="source-line-no">736</span><span id="line-736">  }</span>
<span class="source-line-no">737</span><span id="line-737">}</span>




























































</pre>
</div>
</main>
</body>
</html>
